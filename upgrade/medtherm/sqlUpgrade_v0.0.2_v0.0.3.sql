-- Mise à jour n° de version
UPDATE `system` SET `value`='v0.0.3' WHERE `name`='medtherm' and `groupe`='module';

-- Ajout de paramettres de configurations
INSERT IGNORE INTO `configuration` (`name`, `level`, `toID`, `module`, `cat`, `type`, `description`, `value`) VALUES
('agendaNbJourAvantDebutCureInclureConsult', 'default', '0', 'medtherm', 'Agenda', 'vide/nombre', 'Nombre des jours avant le début d\'une cure ou les consutation peuvent être incluse dans les rendez-vous (si par example la première consultation doit être effectué avant de début de la cure)', '');

-- Ajout du noveau modèle de courrier avec données médicale
SET @catID = (SELECT data_cat.id FROM data_cat WHERE data_cat.name='catModelesCourriers');
INSERT IGNORE INTO `data_types` (`groupe`, `name`, `placeholder`, `label`, `description`, `validationrules`, `validationerrormsg`, `formtype`, `formvalues`, `module`, `cat`, `fromid`, `creationdate`, `durationlife`, `displayorder`) VALUES
('courrier', 'medTheResumeDossierPatient', '', 'Courrier avec données médical', 'Courrier avec données médical', '', '', '', 'courrier-medtheDonneeMedical', 'medtherm', @catID, '1', '2020-07-26 00:00:00', '3600', '1');

-- Les cs autes on maintenant un modèle d'impression
UPDATE forms set printModel = 'medtheCsAutre' WHERE internalName = 'medtheFormCsAutre';

-- Ajout d'un formulaire de résumé des consultation autres pour les courrier de synthèse de cure
SET @catID = (SELECT data_cat.id FROM data_cat WHERE data_cat.name='medtheCatCourrierMT');
INSERT IGNORE INTO `data_types` (`groupe`, `name`, `placeholder`, `label`, `description`, `validationRules`, `validationErrorMsg`, `formType`, `formValues`, `module`, `cat`, `fromID`, `creationDate`, `durationLife`, `displayOrder`) VALUES
('medical', 'medtheCouMtAvecCsAutres', '', 'Inclure les consultations autres', 'Inclus au courrier de synthèse les consultations autres', '', '', 'switch', 'false', 'medtherm', @catID, '1', '2019-01-01 00:00:00', '3600', '1'),
('medical', 'medtheCouMtAvecDonneMedical', '', 'Inclure les données médicales', 'Ajoute les données médicales aux courrier de syntèse', '', '', 'switch', 'false', 'medtherm', @catID, '1', '2019-01-01 00:00:00', '3600', '1'),
('medical', 'medtheCouMtResumCsAut', '', 'Resumé des consultations autres', 'Résumé des consultation autres effectuées pendant la cure', '', '', 'textarea', '', 'medtherm', @catID, '1', '2020-07-28 00:00:00', '3600', '1');

-- Mise à jour du formulaire courrier médecin traitant
SET @catID = (SELECT forms_cat.id FROM forms_cat WHERE forms_cat.name='formsProdOrdoEtDoc');
INSERT IGNORE INTO `forms` (`module`, `internalName`, `name`, `description`, `dataset`, `groupe`, `formMethod`, `formAction`, `cat`, `type`, `yamlStructure`, `options`, `printModel`, `cda`, `javascript`) VALUES
('medtherm', 'medtheFormCourrierMT', 'Médecine thermale : courrier au médecin traitant', '', 'data_types', 'medical', 'post', '/patient/ajax/saveCsForm/', @catID, 'public', 'structure:\r\n  row1:\r\n    head: \"Courrier de synthèse\"\r\n    col1:\r\n      size: col-6\r\n      bloc:\r\n        - medtheCouMtAvecDonneMedical              		#1050 Inclure les données médicales\n    col2:\r\n      size: col-6\r\n      bloc:\r\n        - medtheCouMtAvecCsAutres                  		#1049 Inclure les consultations autres\n  row2:\r\n    col1:\r\n      size: col-2\r\n      bloc: \r\n        - medtheCouMtDateDebut                     		#662  Date de début\n    col2:\r\n      size: col-2\r\n      bloc: \r\n        - medtheCouMtDateFin                       		#663  Date de fin\n    col3:\r\n      size: col-8\r\n      bloc: \r\n        - medtheCouMtOrientations                  		#665  Orientations\n        \r\n  row3:\r\n    col1:\r\n      size: col-2\r\n      bloc: \r\n        - medtheCouMtTaille,plus={cm},class={text-right} 		#676  Taille\n    col2:\r\n      size: col-2\r\n      bloc: \r\n        - medtheCouMtPoidsInitial,plus={kg},class={text-right} 		#668  Poids initial\n    col3:\r\n      size: col-2\r\n      bloc: \r\n        - medtheCouMtPoidsFinal,plus={kg},class={text-right} 		#667  Poids final\n\r\n  row4:\r\n    col1:\r\n      size: col-12\r\n      bloc: \r\n        - medtheCouMtPathoAlgies,rows=3            		#666  Pathologies et algies\n\r\n  row5:\r\n    col1:\r\n      size: col\r\n      bloc: \r\n        - label{ }                                		\n        - label{1re consultation},class={fakeFormBloc}		\n        - label{2e consultation},class={fakeFormBloc}		\n        - label{3e consultation},class={fakeFormBloc}		\n    col2:\r\n      size: col\r\n      bloc: \r\n        - label{TAS}                              		\n        - medtheCouMtTASC1,nolabel,plus={mmHg},class={text-right} 		#673  TAS C1\n        - medtheCouMtTASC2,nolabel,plus={mmHg},class={text-right} 		#674  TAS C2\n        - medtheCouMtTASC3,nolabel,plus={mmHg},class={text-right} 		#675  TAS C3\n    col3:\r\n      size: col\r\n      bloc: \r\n        - label{TAD}                              		\n        - medtheCouMtTADC1,nolabel,plus={mmHg},class={text-right} 		#670  TAD C1\n        - medtheCouMtTADC2,nolabel,plus={mmHg},class={text-right} 		#671  TAD C2\n        - medtheCouMtTADC3,nolabel,plus={mmHg},class={text-right} 		#672  TAD C3\n    col4:\r\n      size: col\r\n      bloc: \r\n        - label{Cheville D}                       		\n        - medtheCouMtCs1CircoChevilleDt,nolabel,plus={cm},class={text-right} 		#654  Circonférence cheville droite C1\n        - label{ },class={fakeFormBloc}           		\n        - medtheCouMtCs3CircoChevilleDt,nolabel,plus={cm},class={text-right} 		#658  Circonférence cheville droite C3\n    col5:\r\n      size: col\r\n      bloc: \r\n        - label{Cheville G}                       		\n        - medtheCouMtCs1CircoChevilleG,nolabel,plus={cm},class={text-right} 		#655  Circonférence cheville gauche C1\n        - label{ },class={fakeFormBloc}           		\n        - medtheCouMtCs3CircoChevilleG,nolabel,plus={cm},class={text-right} 		#659  Circonférence cheville gauche C3\n    col6:\r\n      size: col\r\n      bloc: \r\n        - label{Mollet D}                         		\n        - medtheCouMtCs1CircoMolletDt,nolabel,plus={cm},class={text-right} 		#656  Circonférence mollet droit C1\n        - label{ },class={fakeFormBloc}           		\n        - medtheCouMtCs3CircoMolletDt,nolabel,plus={cm},class={text-right} 		#660  Circonférence mollet droit C3\n    col7:\r\n      size: col\r\n      bloc: \r\n        - label{Mollet G}                         		\n        - medtheCouMtCs1CircoMolletG,nolabel,plus={cm},class={text-right} 		#657  Circonférence mollet gauche C1\n        - label{ },class={fakeFormBloc}           		\n        - medtheCouMtCs3CircoMolletG,nolabel,plus={cm},class={text-right} 		#661  Circonférence mollet gauche C3\n  row6:\r\n    col1:\r\n      size: col-6\r\n      bloc: \r\n        - medtheCouMtSoins,rows=3                  		#669  Soins\n    col2:\r\n      size: col-6\r\n      bloc: \r\n        - medtheCouMtObservation,rows=3            		#664  Observation\n  row7:\r\n    class: courMtAtcdHideShow\r\n    col1:                            \r\n      size: col-12\r\n      bloc:\r\n        - allergies,rows=1                         		#21   Allergies\n        - medtheAtcdPersoMedicaux                  		#643  Antécédents médicaux\n        - medtheAtcdPersoChirugicaux               		#642  Antécédents chirugicaux\n        - medtheAtcdTraitementChro                 		#644  Traitement chronique\n        - medtheAtcdDivers                         		#641  Divers\n\r\n  row8:\r\n    class: courMtAtcdHideShow\r\n    col1:                            \r\n      size: col-12 col-md-6\r\n      bloc:\r\n        - insuffisanceRenale                       		#640  Insuffisance rénale\n    col2:                            \r\n      size: col-12 col-md-6\r\n      bloc:\r\n        - creatinineMicroMolL,plus={µmol/L},class={text-right} 		#75   Créatinine\n        \r\n  row9:\r\n    class: courMtAtcdHideShow\r\n    col1:                            \r\n      size: col-12\r\n      bloc:\r\n        - insuffisanceHepatique                    		#27   Insuffisance hépatique\n        \r\n  row10:\r\n    class: courMtAtcdHideShow\r\n    col1:                            \r\n      size: col-12 col-md-6\r\n      bloc:\r\n        - grossesseActuelle                        		#26   Grossesse en cours\n    col2:                            \r\n      size: col-12 col-md-6\r\n      bloc:\r\n        - allaitementActuel                        		#20   Allaitement\n  row11:\r\n    class: courMtCsAutresShowHide\r\n    col1:\r\n      size: col-12\r\n      bloc:\r\n        - medtheCouMtResumCsAut,rows=10            		#837  Resumé des consultations autres', 'optionsPdf:\r\n  buildPdfOnFormSubmit: true', 'medtheCourrierSynthesMT', '', '$(document).ready(function() {\r\n  \r\n  // Voire ou non le bloc Donnée médicales\r\n  function showATCD(show) {\r\n        if (show) { $(\'.courMtAtcdHideShow\').show(); }\r\n        else { $(\'.courMtAtcdHideShow\').hide(); }\r\n  };\r\n\r\n  // Voire ou non les consultation autres\r\n  function showCsAutres(show) {\r\n          if (show) { $(\'.courMtCsAutresShowHide\').show(); }\r\n          else { $(\'.courMtCsAutresShowHide\').hide(); }\r\n  };\r\n\r\n  // Masquer tototitittutu ou non les bloc selon la valeur des champ gérant leur affichage\r\n  $(\'#id_medtheCouMtAvecDonneMedical_id\').change(function() { showATCD(($(this).val() == \"true\")); });\r\n  $(\'#id_medtheCouMtAvecCsAutres_id\').change(function() { showCsAutres(($(this).val() == \"true\")); });\r\n\r\n  // Voire ou non les bloc Données médicales et autres consultation en fonction de leur valeur par default\r\n  showATCD(($(\'#id_medtheCouMtAvecDonneMedical_id\').val() == \"true\"));\r\n  showCsAutres(($(\'#id_medtheCouMtAvecCsAutres_id\').val() == \"true\"));\r\n  \r\n  // TOTO\r\n  // Utilise tinymce pour formater le champ des consultation autres\r\n  if (tinymce.get(\'id_medtheCouMtResumCsAut_id\') !== null) {\r\n    tinymce.remove(\'#id_medtheCouMtResumCsAut_id\');\r\n  };\r\n  tinymce.init({\r\n    selector: \'#id_medtheCouMtResumCsAut_id\',\r\n    height: \'500\'\r\n  });\r\n    \r\n  //autoresize\r\n  autosize($(\'#formName_medtheFormCourrierMT textarea\'));\r\n});')
ON DUPLICATE KEY UPDATE module=values(module), internalName=values(internalName), name=values(name), description=values(description), dataset=values(dataset), groupe=values(groupe), formMethod=values(formMethod), formAction=values(formAction), cat=@catID, type=values(type), yamlStructure=values(yamlStructure), options=values(options), printModel=values(printModel), cda=values(cda), javascript=values(javascript);
